generator client {
  provider        = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Buyer {
  id               BigInt           @id @default(autoincrement())
  full_name        String
  email            String           @unique
  phone            String?
  created_at       DateTime         @default(now()) @db.Timestamptz(6)
  updated_at       DateTime         @default(now()) @db.Timestamptz(6)
  orders           Order[]
  promo_redemptions PromoRedemption[]

  @@map("buyers")
}

model TicketType {
  id             BigInt    @id @default(autoincrement())
  name           String
  description    String?
  sale_starts_at DateTime? @db.Timestamptz(6)
  sale_ends_at   DateTime? @db.Timestamptz(6)
  base_price     Decimal   @db.Decimal(12, 2)
  currency       String
  is_active      Boolean   @default(true)
  created_at     DateTime  @default(now()) @db.Timestamptz(6)
  updated_at     DateTime  @default(now()) @db.Timestamptz(6)
  tickets        Ticket[]

  @@map("ticket_types")
}

model Ticket {
  id             BigInt      @id @default(autoincrement())
  ticket_type_id BigInt
  status         String
  base_price     Decimal     @db.Decimal(12, 2)
  currency       String
  reserved_until DateTime?   @db.Timestamptz(6)
  created_at     DateTime    @default(now()) @db.Timestamptz(6)
  updated_at     DateTime    @default(now()) @db.Timestamptz(6)
  ticket_type    TicketType  @relation(fields: [ticket_type_id], references: [id])
  order_items    OrderItem[]
  attendee       Attendee?

  @@index([ticket_type_id], map: "idx_tickets_ticket_type_id")
  @@index([status], map: "idx_tickets_status")
  @@map("tickets")
}

model PromoCode {
  id               BigInt           @id @default(autoincrement())
  code             String           @unique
  discount_type    String
  discount_value   Decimal          @db.Decimal(12, 2)
  starts_at        DateTime?        @db.Timestamptz(6)
  ends_at          DateTime?        @db.Timestamptz(6)
  max_redemptions  Int?
  redemptions_count Int             @default(0)
  is_active        Boolean          @default(true)
  created_at       DateTime         @default(now()) @db.Timestamptz(6)
  updated_at       DateTime         @default(now()) @db.Timestamptz(6)
  orders           Order[]
  promo_redemptions PromoRedemption[]

  @@map("promo_codes")
}

model Order {
  id              BigInt           @id @default(autoincrement())
  buyer_id        BigInt
  promo_code_id   BigInt?
  order_status    String
  subtotal_amount Decimal          @db.Decimal(12, 2)
  discount_amount Decimal          @default(0) @db.Decimal(12, 2)
  total_amount    Decimal          @db.Decimal(12, 2)
  currency        String
  payment_oper    String?          @unique
  created_at      DateTime         @default(now()) @db.Timestamptz(6)
  updated_at      DateTime         @default(now()) @db.Timestamptz(6)
  buyer           Buyer            @relation(fields: [buyer_id], references: [id])
  promo_code      PromoCode?       @relation(fields: [promo_code_id], references: [id])
  order_items     OrderItem[]
  payments        Payment[]
  promo_redemptions PromoRedemption[]

  @@index([buyer_id], map: "idx_orders_buyer_id")
  @@index([promo_code_id], map: "idx_orders_promo_code_id")
  @@index([order_status], map: "idx_orders_status")
  @@map("orders")
}

model OrderItem {
  id              BigInt    @id @default(autoincrement())
  order_id        BigInt
  ticket_id       BigInt
  unit_price      Decimal   @db.Decimal(12, 2)
  discount_amount Decimal   @default(0) @db.Decimal(12, 2)
  final_price     Decimal   @db.Decimal(12, 2)
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  updated_at      DateTime  @default(now()) @db.Timestamptz(6)
  order           Order     @relation(fields: [order_id], references: [id])
  ticket          Ticket    @relation(fields: [ticket_id], references: [id])

  @@index([order_id], map: "idx_order_items_order_id")
  @@index([ticket_id], map: "idx_order_items_ticket_id")
  @@map("order_items")
}

model Attendee {
  id                             BigInt    @id @default(autoincrement())
  ticket_id                      BigInt    @unique
  first_name                     String
  last_name                      String
  email                          String
  job_title                      String
  company_name                   String
  company_url                    String?
  work_address                   String?
  country                        String
  work_phone                     String?
  emergency_contact              String?
  github_handle                  String?
  industry                       String
  organization_type              String?
  primary_role                   String?
  organization_represents        String
  first_time_kcd                 Boolean?
  shirt_size                     String?
  dietary_needs                  String?
  disability_accommodation       Boolean?
  person_of_color                String?
  gender_identity                String?
  age_range                      String?
  cncf_communications_consent    Boolean   @default(false)
  sponsor_communications_opt_in  Boolean?
  created_at                     DateTime  @default(now()) @db.Timestamptz(6)
  updated_at                     DateTime  @default(now()) @db.Timestamptz(6)
  ticket                         Ticket    @relation(fields: [ticket_id], references: [id])

  @@index([ticket_id], map: "idx_attendees_ticket_id")
  @@index([email], map: "idx_attendees_email")
  @@map("attendees")
}

model Payment {
  id                 BigInt    @id @default(autoincrement())
  order_id           BigInt
  provider           String
  provider_reference String?
  status             String
  amount             Decimal   @db.Decimal(12, 2)
  currency           String
  created_at         DateTime  @default(now()) @db.Timestamptz(6)
  updated_at         DateTime  @default(now()) @db.Timestamptz(6)
  order              Order     @relation(fields: [order_id], references: [id])

  @@index([order_id], map: "idx_payments_order_id")
  @@index([status], map: "idx_payments_status")
  @@map("payments")
}

model PromoRedemption {
  id            BigInt    @id @default(autoincrement())
  promo_code_id BigInt
  order_id      BigInt
  buyer_id      BigInt
  created_at    DateTime  @default(now()) @db.Timestamptz(6)
  promo_code    PromoCode @relation(fields: [promo_code_id], references: [id])
  order         Order     @relation(fields: [order_id], references: [id])
  buyer         Buyer     @relation(fields: [buyer_id], references: [id])

  @@index([promo_code_id], map: "idx_promo_redemptions_promo_code_id")
  @@index([order_id], map: "idx_promo_redemptions_order_id")
  @@index([buyer_id], map: "idx_promo_redemptions_buyer_id")
  @@map("promo_redemptions")
}
